app-id: com.modrinth.theseus

runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node18
  - org.freedesktop.Sdk.Extension.rust-stable

finish-args:
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --share=network
  - --device=all
  - --socket=pulseaudio

command: modrinth-app

build-options:
  cflags: -g0 -DNDEBUG
  cxxflags: -g0 -DNDEBUG
  strip: true

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gir-1.0

modules:
  # alot of the stuff to build libwebkit2gtk was taken from:
  # https://github.com/flathub/org.telegram.desktop.webview/blob/master/org.telegram.desktop.webview.yml

  - name: unifdef
    no-autogen: true
    make-install-args:
      - prefix=/app
    sources:
      - type: archive
        url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
        sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        x-checker-data:
          type: anitya
          project-id: 5046
          url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
    cleanup:
      - '*'

  - name: libwpe
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/WebPlatformForEmbedded/libwpe/releases/download/1.14.1/libwpe-1.14.1.tar.xz
        sha256: b1d0cdcf0f8dbb494e65b0f7913e357106da9a0d57f4fbb7b9d1238a6dbe9ade
        x-checker-data:
          type: json
          url: https://api.github.com/repos/WebPlatformForEmbedded/libwpe/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/WebPlatformForEmbedded/libwpe/releases/download/\($tag)/libwpe-\($version).tar.xz"'

  - name: wpebackend-fdo
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/Igalia/WPEBackend-fdo/releases/download/1.14.2/wpebackend-fdo-1.14.2.tar.xz
        sha256: 93c9766ae9864eeaeaee2b0a74f22cbca08df42c1a1bdb55b086f2528e380d38
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Igalia/WPEBackend-fdo/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/Igalia/WPEBackend-fdo/releases/download/\($tag)/wpebackend-fdo-\($version).tar.xz"'

  - name: libsoup
    buildsystem: meson
    builddir: true
    config-opts:
      - -Dvapi=disabled
      - -Dgtk_doc=false
      - -Dtests=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libsoup/2.74/libsoup-2.74.3.tar.xz
        sha256: e4b77c41cfc4c8c5a035fcdc320c7bc6cfb75ef7c5a034153df1413fa1d92f13

  - name: webkitgtk
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DUSE_SOUP2=ON
      - -DPORT=GTK
      - -DUSE_LIBSECRET=OFF
      - -DUSE_WOFF2=OFF
      - -DUSE_AVIF=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.40.5.tar.xz
        sha256: 7de051a263668621d91a61a5eb1c3771d1a7cec900043d4afef06c326c16037f

  - name: bzip2
    buildsystem: simple
    build-commands:
      - make -f Makefile-libbz2_so
      - install -Dm644 libbz2.so.1.0.8 -t /app/lib
      - ln -s libbz2.so.1.0.8 /app/lib/libbz2.so.1.0
      - ln -s libbz2.so.1.0.8 /app/lib/libbz2.so
    sources:
      - type: archive
        url: https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        sha256: ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269

  - name: modrinth-app
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node18/bin:/usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/modrinth-app/cargo
      build-args:
        - --share=network # this won't be allowed in the actual flatpak
    build-commands:
      - |
        set -e

        cd theseus_gui
        jq '.tauri.updater.active=false|.tauri.bundle.active=false' src-tauri/tauri.conf.json > tmp.json
        mv tmp.json src-tauri/tauri.conf.json

        npx pnpm install # this is the line we want to get rid of

        cargo --offline fetch --manifest-path src-tauri/Cargo.toml
        npx pnpm tauri build -- --offline

        install -Dm755 ../target/release/modrinth-app -t /app/bin
    sources:
      - type: archive
        url: https://github.com/modrinth/theseus/archive/v0.4.0.tar.gz
        sha256: 2ef378704702216a60e1bc7c3f804edc04a6bba9cd7d07db1a366a0f3782033a
      # sources for cargo dependencies generated by https://github.com/flatpak/flatpak-builder-tools/tree/master/cargo
      - cargo-sources.json
