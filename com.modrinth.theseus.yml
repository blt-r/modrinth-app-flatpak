app-id: com.modrinth.theseus

runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node18
  - org.freedesktop.Sdk.Extension.rust-stable

finish-args:
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --share=network
  - --device=all
  - --socket=pulseaudio

command: modrinth-app

build-options:
  cflags: -g0 -DNDEBUG
  cxxflags: -g0 -DNDEBUG
  strip: true

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gir-1.0

modules:
  # alot of the stuff to build libwebkit2gtk was taken from:
  # https://github.com/flathub/org.telegram.desktop.webview/blob/master/org.telegram.desktop.webview.yml

  - name: unifdef
    no-autogen: true
    make-install-args:
      - prefix=/app
    sources:
      - type: archive
        url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
        sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        x-checker-data:
          type: anitya
          project-id: 5046
          url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
    cleanup:
      - '*'

  - name: libwpe
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/WebPlatformForEmbedded/libwpe/releases/download/1.14.1/libwpe-1.14.1.tar.xz
        sha256: b1d0cdcf0f8dbb494e65b0f7913e357106da9a0d57f4fbb7b9d1238a6dbe9ade
        x-checker-data:
          type: json
          url: https://api.github.com/repos/WebPlatformForEmbedded/libwpe/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/WebPlatformForEmbedded/libwpe/releases/download/\($tag)/libwpe-\($version).tar.xz"'

  - name: wpebackend-fdo
    buildsystem: meson
    builddir: true
    config-opts:
      - --buildtype=plain
    sources:
      - type: archive
        url: https://github.com/Igalia/WPEBackend-fdo/releases/download/1.14.2/wpebackend-fdo-1.14.2.tar.xz
        sha256: 93c9766ae9864eeaeaee2b0a74f22cbca08df42c1a1bdb55b086f2528e380d38
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Igalia/WPEBackend-fdo/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag
          url-query: '"https://github.com/Igalia/WPEBackend-fdo/releases/download/\($tag)/wpebackend-fdo-\($version).tar.xz"'

  - name: libsoup-2.4
    buildsystem: meson
    builddir: true
    config-opts:
      - -Dvapi=disabled
      - -Dgtk_doc=false
      - -Dtests=false
      - -Dgnome=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libsoup/2.74/libsoup-2.74.3.tar.xz
        sha256: e4b77c41cfc4c8c5a035fcdc320c7bc6cfb75ef7c5a034153df1413fa1d92f13
    cleanup:
      - '/share/locale'
      - '/share/runtime/locale'

  - name: webkitgtk
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DUSE_SOUP2=ON
      - -DPORT=GTK
      - -DUSE_LIBSECRET=OFF
      - -DUSE_WOFF2=OFF
      - -DUSE_AVIF=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.40.5.tar.xz
        sha256: 7de051a263668621d91a61a5eb1c3771d1a7cec900043d4afef06c326c16037f
    cleanup:
      - '/share/locale'
      - '/share/runtime/locale'

  - name: modrinth-app
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node18/bin:/usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/modrinth-app/cargo
      build-args:
        - --share=network # this won't be allowed in the actual flatpak
    build-commands:
      - cd theseus_gui && npx pnpm install # this is illegal
      - cd theseus_gui && npx pnpm build

      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release

      - install -Dm755 target/release/theseus_gui /app/bin/modrinth-app
    sources:
      - type: archive
        url: https://github.com/modrinth/theseus/archive/5f0d44a8810ec01bd4c6ccc6407d2217cb9b18ed.tar.gz
        sha256: 56ebda6001627c820b5b4289e6307fb0c1d7570fe6b35b3ed348a11356046954
      # sources for cargo dependencies generated by https://github.com/flatpak/flatpak-builder-tools/tree/master/cargo
      - cargo-sources.json
